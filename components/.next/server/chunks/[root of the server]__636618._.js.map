{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 47, "column": 0}, "map": {"version":3,"sources":["turbopack://[project]/lib/supabase-admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\n// URL e Service Key do Supabase (server-side only)\nconst supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || 'http://kong:8000';\nconst supabaseServiceKey =\n  process.env.SUPABASE_SERVICE_ROLE_KEY ||\n  process.env.SUPABASE_SECRET_KEY ||\n  process.env.SUPABASE_SERVICE_KEY ||\n  '';\n\nif (!supabaseServiceKey) {\n  console.warn('??  SUPABASE_SERVICE_ROLE_KEY or SUPABASE_SECRET_KEY not set - admin client will not work');\n}\n\n// Cliente Supabase Admin (bypassa Row Level Security)\n// APENAS para uso server-side (API routes, server components)\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false,\n  },\n});\n\n/**\n * Tipos de dados do banco\n */\n\nexport interface User {\n  id: string;\n  email: string;\n  displayName: string;\n  role: 'developer' | 'admin' | 'manager' | 'agent' | 'buyer';\n  companyId: string | null;\n  storeId: string | null;\n  storeIds: string[];\n  active: boolean;\n  createdAt: string;\n  lastSeen: string | null;\n  isOnline?: boolean;\n}\n\nexport interface Company {\n  id: string;\n  name: string;\n  tradingName?: string;\n  cnpj?: string;\n  active: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface Store {\n  id: string;\n  name: string;\n  code: string;\n  companyId: string;\n  managerId?: string | null;\n  agentId?: string | null;\n  address?: string;\n  city?: string;\n  state?: string;\n  active: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\ntype DbUser = {\n  id: string;\n  email: string;\n  display_name: string | null;\n  role: string;\n  company_id: string | null;\n  store_id: string | null;\n  store_ids: string[] | null;\n  active: boolean | null;\n  created_at: string;\n  last_seen: string | null;\n};\n\ntype DbCompany = {\n  id: string;\n  name: string;\n  cnpj: string | null;\n  trading_name: string | null;\n  active: boolean | null;\n  created_at: string;\n  updated_at: string;\n};\n\ntype DbStore = {\n  id: string;\n  name: string;\n  code: string;\n  company_id: string;\n  manager_id: string | null;\n  agent_id: string | null;\n  address: string | null;\n  city: string | null;\n  state: string | null;\n  active: boolean | null;\n  created_at: string;\n  updated_at: string;\n};\n\nfunction mapUserRow(row: DbUser): User {\n  const lastSeen = row.last_seen ?? null;\n  const isOnline = lastSeen ? (Date.now() - new Date(lastSeen).getTime() < 5 * 60 * 1000) : false;\n  return {\n    id: row.id,\n    email: row.email,\n    displayName: row.display_name || row.email || 'Sem nome',\n    role: row.role as User['role'],\n    companyId: row.company_id,\n    storeId: row.store_id,\n    storeIds: Array.isArray(row.store_ids) ? row.store_ids : (row.store_id ? [row.store_id] : []),\n    active: row.active !== false,\n    createdAt: row.created_at,\n    lastSeen,\n    isOnline,\n  };\n}\n\nfunction mapCompanyRow(row: DbCompany): Company {\n  return {\n    id: row.id,\n    name: row.name,\n    tradingName: row.trading_name ?? undefined,\n    cnpj: row.cnpj ?? undefined,\n    active: row.active !== false,\n    createdAt: row.created_at,\n    updatedAt: row.updated_at,\n  };\n}\n\nfunction mapStoreRow(row: DbStore): Store {\n  return {\n    id: row.id,\n    name: row.name,\n    code: row.code,\n    companyId: row.company_id,\n    managerId: row.manager_id ?? null,\n    agentId: row.agent_id ?? null,\n    address: row.address ?? undefined,\n    city: row.city ?? undefined,\n    state: row.state ?? undefined,\n    active: row.active !== false,\n    createdAt: row.created_at,\n    updatedAt: row.updated_at,\n  };\n}\n\n/**\n * Helper Functions para opera‚Ä°√§es comuns\n */\n\n// ========================================\n// USERS\n// ========================================\n\nexport async function getAllUsers() {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .order('created_at', { ascending: false });\n\n  if (error) throw error;\n  return (data || []).map(mapUserRow);\n}\n\nexport async function getUserById(userId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .eq('id', userId)\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function getUsersByCompany(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .eq('company_id', companyId)\n    .order('created_at', { ascending: false });\n\n  if (error) throw error;\n  return (data || []).map(mapUserRow);\n}\n\nexport async function createUser(user: Partial<User>) {\n  const payload = {\n    id: user.id,\n    email: user.email,\n    display_name: user.displayName ?? null,\n    role: user.role,\n    company_id: user.companyId ?? null,\n    store_id: user.storeId ?? null,\n    store_ids: user.storeIds ?? (user.storeId ? [user.storeId] : []),\n    active: user.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function updateUser(userId: string, updates: Partial<User>) {\n  const payload: Partial<DbUser> & { updated_at?: string } = {\n    display_name: updates.displayName,\n    role: updates.role,\n    company_id: updates.companyId ?? undefined,\n    store_id: updates.storeId ?? undefined,\n    store_ids: updates.storeIds,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .update(payload)\n    .eq('id', userId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function deleteUser(userId: string) {\n  const { error } = await supabaseAdmin\n    .from('users')\n    .delete()\n    .eq('id', userId);\n\n  if (error) throw error;\n}\n\n// ========================================\n// COMPANIES\n// ========================================\n\nexport async function getAllCompanies() {\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .select('*')\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapCompanyRow);\n}\n\nexport async function getCompanyById(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .select('*')\n    .eq('id', companyId)\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\nexport async function createCompany(company: Partial<Company>) {\n  const payload = {\n    id: company.id,\n    name: company.name,\n    trading_name: company.tradingName ?? null,\n    cnpj: company.cnpj ?? null,\n    active: company.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\nexport async function updateCompany(companyId: string, updates: Partial<Company>) {\n  const payload = {\n    name: updates.name,\n    trading_name: updates.tradingName ?? undefined,\n    cnpj: updates.cnpj ?? undefined,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .update(payload)\n    .eq('id', companyId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\n// ========================================\n// STORES\n// ========================================\n\nexport async function getAllStores() {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapStoreRow);\n}\n\nexport async function getStoresByCompany(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .eq('company_id', companyId)\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapStoreRow);\n}\n\nexport async function getStoreById(storeId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .eq('id', storeId)\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\nexport async function createStore(store: Partial<Store>) {\n  const payload = {\n    id: store.id,\n    name: store.name,\n    code: store.code,\n    company_id: store.companyId,\n    manager_id: store.managerId ?? null,\n    agent_id: store.agentId ?? null,\n    address: store.address ?? null,\n    city: store.city ?? null,\n    state: store.state ?? null,\n    active: store.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\nexport async function updateStore(storeId: string, updates: Partial<Store>) {\n  const payload = {\n    name: updates.name,\n    code: updates.code,\n    company_id: updates.companyId,\n    manager_id: updates.managerId ?? undefined,\n    agent_id: updates.agentId ?? undefined,\n    address: updates.address ?? undefined,\n    city: updates.city ?? undefined,\n    state: updates.state ?? undefined,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .update(payload)\n    .eq('id', storeId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\n/**\n * Helper para verificar JWT token do usu¬†rio\n */\nexport async function verifyToken(token: string) {\n  const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);\n\n  if (error) throw error;\n  return user;\n}\n\nexport default supabaseAdmin;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 276, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 282, "column": 0}, "map": {"version":3,"sources":["turbopack://[project]/app/api/mensagens/[id]/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { supabaseAdmin } from '@/lib/supabase-admin';\n\n// Desabilitar cache para sempre retornar dados atualizados\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\n/**\n * GET /api/mensagens/[id]\n * Busca uma conversa espec√≠fica e lista todas as suas mensagens\n * Compat√≠vel com estrutura do mobile: conversations/{id}/messages\n * Query params:\n *   - userId: opcional, filtra mensagens deletadas por este usu√°rio\n */\nexport async function GET(\n  _req: NextRequest,\n  context: { params: Promise<{ id: string }> }\n) {\n  const { id } = await context.params;\n  const { searchParams } = new URL(_req.url);\n  const userId = searchParams.get('userId');\n\n  console.log('üì® GET /api/mensagens/[id] - conversationId:', id, 'userId:', userId);\n\n  try {\n    // Buscar conversa\n    const { data: conversationData, error: conversationError } = await supabaseAdmin\n      .from('conversations')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (conversationError || !conversationData) {\n      return NextResponse.json({ error: 'Conversa n√£o encontrada' }, { status: 404 });\n    }\n\n    // Buscar status online dos participantes\n    const participants = conversationData.participants || [];\n    const onlineStatus: Record<string, boolean> = {};\n\n    if (participants.length > 0) {\n      const { data: users, error: usersError } = await supabaseAdmin\n        .from('users')\n        .select('id, last_seen')\n        .in('id', participants);\n\n      if (!usersError && users) {\n        users.forEach((user: any) => {\n          const lastSeen = user.last_seen ? new Date(user.last_seen) : null;\n          // Considera online se lastSeen foi nos √∫ltimos 5 minutos\n          onlineStatus[user.id] = lastSeen ? (Date.now() - lastSeen.getTime() < 5 * 60 * 1000) : false;\n        });\n      }\n    }\n\n    const conversation = {\n      id: conversationData.id,\n      participants,\n      participantNames: conversationData.participant_names || {},\n      lastMessage: conversationData.last_message || '',\n      lastMessageAt: conversationData.last_message_at || new Date(0).toISOString(),\n      lastMessageBy: conversationData.last_message_by || '',\n      unreadCount: conversationData.unread_count || {},\n      createdAt: conversationData.created_at || new Date(0).toISOString(),\n      onlineStatus, // Status online dos participantes\n    };\n\n    // Buscar mensagens da conversa\n    const { data: messagesData, error: messagesError } = await supabaseAdmin\n      .from('chat_messages')\n      .select('*')\n      .eq('conversation_id', id)\n      .order('created_at', { ascending: true });\n\n    if (messagesError) {\n      console.error('[Mensagens] Erro ao buscar mensagens:', messagesError);\n    }\n\n    const allMessages = (messagesData || []).map((data: any) => ({\n      id: data.id,\n      conversationId: data.conversation_id || id,\n      senderId: data.sender_id || '',\n      senderName: data.sender_name || 'Usu√°rio',\n      receiverId: data.receiver_id || '',\n      text: data.text || '',\n      createdAt: data.created_at || new Date(0).toISOString(),\n      read: data.read === true,\n      edited: data.edited === true,\n      editedAt: data.edited_at || null,\n      attachments: data.attachments || [],\n      deletedBy: data.deleted_by || [],\n      deletedForEveryone: data.deleted_for_everyone === true,\n      deletedForEveryoneAt: data.deleted_for_everyone_at || null,\n    }));\n\n    console.log('üì® GET - Total mensagens no Supabase:', allMessages.length);\n    console.log('üì® GET - Mensagens com deletedBy:', allMessages.filter((m: any) => m.deletedBy && m.deletedBy.length > 0).length);\n    console.log('üì® GET - Mensagens deletedForEveryone:', allMessages.filter((m: any) => m.deletedForEveryone).length);\n\n    // Filtrar mensagens deletadas pelo usu√°rio (se userId fornecido)\n    const messages = allMessages\n      .filter((msg: any) => {\n        // Se foi deletada para todos, mostrar apenas placeholder (manter na lista)\n        if (msg.deletedForEveryone) {\n          return true; // Mant√©m na lista para mostrar placeholder\n        }\n\n        if (!userId) {\n          console.log('üì® GET - Sem filtro de userId, retornando todas');\n          return true;\n        }\n\n        const isDeleted = msg.deletedBy.includes(userId);\n        if (isDeleted) {\n          console.log('üì® GET - Filtrando mensagem deletada:', msg.id);\n        }\n        return !isDeleted;\n      })\n      .sort((a: any, b: any) => new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime());\n\n    console.log('üì® GET - Mensagens ap√≥s filtro:', messages.length);\n\n    return NextResponse.json({ conversation, messages });\n  } catch (error) {\n    console.error('Erro ao buscar conversa:', error);\n    return NextResponse.json({ error: 'Falha ao buscar conversa' }, { status: 500 });\n  }\n}\n\n/**\n * PATCH /api/mensagens/[id]\n * Marca todas as mensagens de uma conversa como lidas para um usu√°rio\n */\nexport async function PATCH(\n  req: NextRequest,\n  context: { params: Promise<{ id: string }> }\n) {\n  const { id } = await context.params;\n  try {\n    const body = await req.json().catch(() => ({}));\n    const userId = body.userId;\n\n    if (!userId) {\n      return NextResponse.json({ error: 'userId √© obrigat√≥rio' }, { status: 400 });\n    }\n\n    // Verificar se conversa existe\n    const { data: conversationData, error: conversationError } = await supabaseAdmin\n      .from('conversations')\n      .select('*')\n      .eq('id', id)\n      .single();\n\n    if (conversationError || !conversationData) {\n      return NextResponse.json({ error: 'Conversa n√£o encontrada' }, { status: 404 });\n    }\n\n    // Marcar todas as mensagens n√£o lidas como lidas\n    const { data: unreadMessages, error: updateError } = await supabaseAdmin\n      .from('chat_messages')\n      .update({ read: true })\n      .eq('conversation_id', id)\n      .eq('receiver_id', userId)\n      .eq('read', false)\n      .select('id');\n\n    if (updateError) {\n      console.error('[Mensagens] Erro ao marcar como lidas:', updateError);\n    }\n\n    const updatedCount = unreadMessages?.length || 0;\n\n    // Zerar contador de n√£o lidas na conversa\n    const currentUnreadCount = conversationData.unread_count || {};\n    const newUnreadCount = { ...currentUnreadCount };\n    newUnreadCount[userId] = 0;\n\n    await supabaseAdmin\n      .from('conversations')\n      .update({\n        unread_count: newUnreadCount,\n      })\n      .eq('id', id);\n\n    return NextResponse.json({\n      success: true,\n      message: 'Mensagens marcadas como lidas',\n      updatedCount,\n    });\n  } catch (error) {\n    console.error('Erro ao atualizar conversa:', error);\n    return NextResponse.json({ error: 'Falha ao atualizar conversa' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 441, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}