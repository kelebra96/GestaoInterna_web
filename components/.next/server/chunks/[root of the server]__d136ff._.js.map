{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 63, "column": 0}, "map": {"version":3,"sources":["turbopack://[project]/lib/supabase-admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\n// URL e Service Key do Supabase (server-side only)\nconst supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || 'http://kong:8000';\nconst supabaseServiceKey =\n  process.env.SUPABASE_SERVICE_ROLE_KEY ||\n  process.env.SUPABASE_SECRET_KEY ||\n  process.env.SUPABASE_SERVICE_KEY ||\n  '';\n\nif (!supabaseServiceKey) {\n  console.warn('??  SUPABASE_SERVICE_ROLE_KEY or SUPABASE_SECRET_KEY not set - admin client will not work');\n}\n\n// Cliente Supabase Admin (bypassa Row Level Security)\n// APENAS para uso server-side (API routes, server components)\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false,\n  },\n});\n\n/**\n * Tipos de dados do banco\n */\n\nexport interface User {\n  id: string;\n  email: string;\n  displayName: string;\n  role: 'developer' | 'admin' | 'manager' | 'agent' | 'buyer';\n  companyId: string | null;\n  storeId: string | null;\n  storeIds: string[];\n  active: boolean;\n  createdAt: string;\n  lastSeen: string | null;\n  isOnline?: boolean;\n}\n\nexport interface Company {\n  id: string;\n  name: string;\n  tradingName?: string;\n  cnpj?: string;\n  active: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface Store {\n  id: string;\n  name: string;\n  code: string;\n  companyId: string;\n  managerId?: string | null;\n  agentId?: string | null;\n  address?: string;\n  city?: string;\n  state?: string;\n  active: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\ntype DbUser = {\n  id: string;\n  email: string;\n  display_name: string | null;\n  role: string;\n  company_id: string | null;\n  store_id: string | null;\n  store_ids: string[] | null;\n  active: boolean | null;\n  created_at: string;\n  last_seen: string | null;\n};\n\ntype DbCompany = {\n  id: string;\n  name: string;\n  cnpj: string | null;\n  trading_name: string | null;\n  active: boolean | null;\n  created_at: string;\n  updated_at: string;\n};\n\ntype DbStore = {\n  id: string;\n  name: string;\n  code: string;\n  company_id: string;\n  manager_id: string | null;\n  agent_id: string | null;\n  address: string | null;\n  city: string | null;\n  state: string | null;\n  active: boolean | null;\n  created_at: string;\n  updated_at: string;\n};\n\nfunction mapUserRow(row: DbUser): User {\n  const lastSeen = row.last_seen ?? null;\n  const isOnline = lastSeen ? (Date.now() - new Date(lastSeen).getTime() < 5 * 60 * 1000) : false;\n  return {\n    id: row.id,\n    email: row.email,\n    displayName: row.display_name || row.email || 'Sem nome',\n    role: row.role as User['role'],\n    companyId: row.company_id,\n    storeId: row.store_id,\n    storeIds: Array.isArray(row.store_ids) ? row.store_ids : (row.store_id ? [row.store_id] : []),\n    active: row.active !== false,\n    createdAt: row.created_at,\n    lastSeen,\n    isOnline,\n  };\n}\n\nfunction mapCompanyRow(row: DbCompany): Company {\n  return {\n    id: row.id,\n    name: row.name,\n    tradingName: row.trading_name ?? undefined,\n    cnpj: row.cnpj ?? undefined,\n    active: row.active !== false,\n    createdAt: row.created_at,\n    updatedAt: row.updated_at,\n  };\n}\n\nfunction mapStoreRow(row: DbStore): Store {\n  return {\n    id: row.id,\n    name: row.name,\n    code: row.code,\n    companyId: row.company_id,\n    managerId: row.manager_id ?? null,\n    agentId: row.agent_id ?? null,\n    address: row.address ?? undefined,\n    city: row.city ?? undefined,\n    state: row.state ?? undefined,\n    active: row.active !== false,\n    createdAt: row.created_at,\n    updatedAt: row.updated_at,\n  };\n}\n\n/**\n * Helper Functions para opera‡äes comuns\n */\n\n// ========================================\n// USERS\n// ========================================\n\nexport async function getAllUsers() {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .order('created_at', { ascending: false });\n\n  if (error) throw error;\n  return (data || []).map(mapUserRow);\n}\n\nexport async function getUserById(userId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .eq('id', userId)\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function getUsersByCompany(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .eq('company_id', companyId)\n    .order('created_at', { ascending: false });\n\n  if (error) throw error;\n  return (data || []).map(mapUserRow);\n}\n\nexport async function createUser(user: Partial<User>) {\n  const payload = {\n    id: user.id,\n    email: user.email,\n    display_name: user.displayName ?? null,\n    role: user.role,\n    company_id: user.companyId ?? null,\n    store_id: user.storeId ?? null,\n    store_ids: user.storeIds ?? (user.storeId ? [user.storeId] : []),\n    active: user.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function updateUser(userId: string, updates: Partial<User>) {\n  const payload: Partial<DbUser> & { updated_at?: string } = {\n    display_name: updates.displayName,\n    role: updates.role,\n    company_id: updates.companyId ?? undefined,\n    store_id: updates.storeId ?? undefined,\n    store_ids: updates.storeIds,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .update(payload)\n    .eq('id', userId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function deleteUser(userId: string) {\n  const { error } = await supabaseAdmin\n    .from('users')\n    .delete()\n    .eq('id', userId);\n\n  if (error) throw error;\n}\n\n// ========================================\n// COMPANIES\n// ========================================\n\nexport async function getAllCompanies() {\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .select('*')\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapCompanyRow);\n}\n\nexport async function getCompanyById(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .select('*')\n    .eq('id', companyId)\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\nexport async function createCompany(company: Partial<Company>) {\n  const payload = {\n    id: company.id,\n    name: company.name,\n    trading_name: company.tradingName ?? null,\n    cnpj: company.cnpj ?? null,\n    active: company.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\nexport async function updateCompany(companyId: string, updates: Partial<Company>) {\n  const payload = {\n    name: updates.name,\n    trading_name: updates.tradingName ?? undefined,\n    cnpj: updates.cnpj ?? undefined,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .update(payload)\n    .eq('id', companyId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\n// ========================================\n// STORES\n// ========================================\n\nexport async function getAllStores() {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapStoreRow);\n}\n\nexport async function getStoresByCompany(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .eq('company_id', companyId)\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapStoreRow);\n}\n\nexport async function getStoreById(storeId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .eq('id', storeId)\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\nexport async function createStore(store: Partial<Store>) {\n  const payload = {\n    id: store.id,\n    name: store.name,\n    code: store.code,\n    company_id: store.companyId,\n    manager_id: store.managerId ?? null,\n    agent_id: store.agentId ?? null,\n    address: store.address ?? null,\n    city: store.city ?? null,\n    state: store.state ?? null,\n    active: store.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\nexport async function updateStore(storeId: string, updates: Partial<Store>) {\n  const payload = {\n    name: updates.name,\n    code: updates.code,\n    company_id: updates.companyId,\n    manager_id: updates.managerId ?? undefined,\n    agent_id: updates.agentId ?? undefined,\n    address: updates.address ?? undefined,\n    city: updates.city ?? undefined,\n    state: updates.state ?? undefined,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .update(payload)\n    .eq('id', storeId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\n/**\n * Helper para verificar JWT token do usu rio\n */\nexport async function verifyToken(token: string) {\n  const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);\n\n  if (error) throw error;\n  return user;\n}\n\nexport default supabaseAdmin;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 292, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 298, "column": 0}, "map": {"version":3,"sources":["turbopack://[project]/lib/helpers/auth.ts"],"sourcesContent":["// web/lib/helpers/auth.ts\nimport { Buffer } from 'buffer';\nimport { Role } from '@prisma/client';\nimport { z } from 'zod';\nimport { supabaseAdmin } from '@/lib/supabase-admin';\n\nconst AuthPayloadSchema = z.object({\n  userId: z.string(),\n  orgId: z.string(),\n  role: z.nativeEnum(Role),\n  storeIds: z.array(z.string()).default([]),\n  iat: z.number().optional(),\n  exp: z.number().optional(),\n});\nexport type AuthPayload = z.infer<typeof AuthPayloadSchema>;\n\n// Maps roles from Supabase/public.users to the Prisma Role enum\nconst roleMapping: Record<string, Role> = {\n  super_admin: Role.super_admin,\n  admin_rede: Role.admin_rede,\n  gestor_loja: Role.gestor_loja,\n  merchandiser: Role.merchandiser,\n  repositor: Role.repositor,\n  developer: Role.super_admin, // legacy role -> highest access\n  admin: Role.admin_rede,\n  manager: Role.gestor_loja,\n  agent: Role.repositor,\n  buyer: Role.merchandiser,\n};\n\nfunction mapRole(rawRole?: string | null): Role {\n  if (!rawRole) return Role.repositor; // Role padrao mais restritiva\n  const normalized = String(rawRole).toLowerCase();\n  return roleMapping[normalized] || Role.repositor;\n}\n\nfunction decodeJwtWithoutVerification(token: string): Record<string, unknown> | null {\n  try {\n    const parts = token.split('.');\n    if (parts.length < 2) return null;\n    const payload = parts[1];\n    const decoded = Buffer.from(payload.replace(/-/g, '+').replace(/_/g, '/'), 'base64').toString('utf8');\n    return JSON.parse(decoded);\n  } catch (error) {\n    console.error('Failed to decode bearer token:', error);\n    return null;\n  }\n}\n\ntype UserProfileRow = {\n  id: string;\n  role: string | null;\n  company_id: string | null;\n  store_id: string | null;\n  store_ids: string[] | null;\n};\n\nasync function fetchUserProfile(userId: string): Promise<UserProfileRow | null> {\n  try {\n    const { data, error } = await supabaseAdmin\n      .from('users')\n      .select('id, role, company_id, store_id, store_ids')\n      .eq('id', userId)\n      .maybeSingle();\n\n    if (error) {\n      console.error('Error fetching user profile from Supabase:', error);\n      return null;\n    }\n\n    return data as UserProfileRow;\n  } catch (error) {\n    console.error('Error fetching user profile from Supabase:', error);\n    return null;\n  }\n}\n\n/**\n * Extracts and parses the user authentication payload from the request headers.\n * Supports Firebase Auth tokens with x-user-payload header.\n */\nexport async function getAuthFromRequest(request: Request): Promise<AuthPayload | null> {\n  const authHeader = request.headers.get('authorization');\n  const bearer = authHeader?.startsWith('Bearer ') ? authHeader.slice(7) : null;\n  if (!bearer) return null;\n\n  // Decode JWT to get basic info (Firebase token)\n  const decodedFromBearer = decodeJwtWithoutVerification(bearer);\n  if (!decodedFromBearer) {\n    console.error('Failed to decode bearer token');\n    return null;\n  }\n\n  try {\n    // 1. Try to get user payload from x-user-payload header (set by frontend)\n    const userPayloadHeader = request.headers.get('x-user-payload');\n    if (userPayloadHeader) {\n      try {\n        const parsed = JSON.parse(userPayloadHeader);\n        const payload = {\n          userId: parsed.userId || decodedFromBearer['user_id'] || decodedFromBearer['sub'],\n          orgId: parsed.orgId || parsed.companyId || 'unknown-org',\n          role: mapRole(parsed.role),\n          storeIds: Array.isArray(parsed.storeIds) ? parsed.storeIds : [],\n          iat: decodedFromBearer?.['iat'] as number | undefined,\n          exp: decodedFromBearer?.['exp'] as number | undefined,\n        };\n\n        const validation = AuthPayloadSchema.safeParse(payload);\n        if (validation.success) {\n          return validation.data;\n        }\n      } catch (parseError) {\n        console.error('Failed to parse x-user-payload header:', parseError);\n      }\n    }\n\n    // 2. Extract user ID from Firebase token\n    const userId = decodedFromBearer['user_id'] || decodedFromBearer['sub'];\n    if (!userId || typeof userId !== 'string') {\n      console.error('No user ID found in token');\n      return null;\n    }\n\n    // 3. Fetch user profile from Supabase database\n    const profile = await fetchUserProfile(userId);\n\n    const roleValue =\n      profile?.role ||\n      (decodedFromBearer?.['role'] as string | undefined);\n\n    const orgIdValue =\n      profile?.company_id ||\n      (decodedFromBearer?.['orgId'] as string | undefined) ||\n      (decodedFromBearer?.['companyId'] as string | undefined) ||\n      (decodedFromBearer?.['company_id'] as string | undefined);\n\n    let storeIdsValue: string[] = [];\n    if (Array.isArray(profile?.store_ids) && profile?.store_ids.length > 0) {\n      storeIdsValue = profile.store_ids;\n    } else if (profile?.store_id) {\n      storeIdsValue = [profile.store_id];\n    }\n\n    const payload = {\n      userId: userId,\n      orgId: orgIdValue || 'unknown-org',\n      role: mapRole(roleValue),\n      storeIds: storeIdsValue,\n      iat: decodedFromBearer?.['iat'] as number | undefined,\n      exp: decodedFromBearer?.['exp'] as number | undefined,\n    };\n\n    const validation = AuthPayloadSchema.safeParse(payload);\n    if (!validation.success) {\n      console.error('Auth payload validation failed:', validation.error);\n      return null;\n    }\n\n    return validation.data;\n  } catch (error) {\n    console.error('Failed to validate auth payload:', error);\n    return null;\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 430, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 436, "column": 0}, "map": {"version":3,"sources":["turbopack://[project]/app/api/auth/me/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { getAuthFromRequest } from '@/lib/helpers/auth';\nimport { supabaseAdmin } from '@/lib/supabase-admin';\n\ntype DbUser = {\n  id: string;\n  email: string;\n  display_name: string | null;\n  role: string;\n  company_id: string | null;\n  store_id: string | null;\n  store_ids: string[] | null;\n  active: boolean | null;\n  created_at: string;\n  updated_at: string;\n};\n\nexport async function GET(request: Request) {\n  const auth = await getAuthFromRequest(request);\n  if (!auth) {\n    return NextResponse.json({ error: 'Não autorizado' }, { status: 401 });\n  }\n\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('id, display_name, email, role, store_id, company_id, active, created_at, updated_at')\n    .eq('id', auth.userId)\n    .maybeSingle();\n\n  if (error || !data) {\n    return NextResponse.json({ error: 'Usuário não encontrado' }, { status: 404 });\n  }\n\n  const row = data as DbUser;\n  return NextResponse.json({\n    user: {\n      uid: row.id,\n      displayName: row.display_name || row.email || 'Sem nome',\n      email: row.email,\n      role: row.role,\n      storeId: row.store_id || undefined,\n      companyId: row.company_id || undefined,\n      active: row.active !== false,\n      createdAt: row.created_at,\n      updatedAt: row.updated_at,\n    },\n  });\n}\n"],"names":[],"mappings":";;;AAAA;AACA;AACA;;;;AAeO,eAAe,IAAI,OAAgB;IACxC,MAAM,OAAO,MAAM,CAAA,GAAA,wHAAA,CAAA,qBAAkB,AAAD,EAAE;IACtC,IAAI,CAAC,MAAM;QACT,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;IACtE;IAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,0HAAA,CAAA,gBAAa,CACxC,IAAI,CAAC,SACL,MAAM,CAAC,uFACP,EAAE,CAAC,MAAM,KAAK,MAAM,EACpB,WAAW;IAEd,IAAI,SAAS,CAAC,MAAM;QAClB,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB,GAAG;YAAE,QAAQ;QAAI;IAC9E;IAEA,MAAM,MAAM;IACZ,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;QACvB,MAAM;YACJ,KAAK,IAAI,EAAE;YACX,aAAa,IAAI,YAAY,IAAI,IAAI,KAAK,IAAI;YAC9C,OAAO,IAAI,KAAK;YAChB,MAAM,IAAI,IAAI;YACd,SAAS,IAAI,QAAQ,IAAI;YACzB,WAAW,IAAI,UAAU,IAAI;YAC7B,QAAQ,IAAI,MAAM,KAAK;YACvB,WAAW,IAAI,UAAU;YACzB,WAAW,IAAI,UAAU;QAC3B;IACF;AACF"}},
    {"offset": {"line": 477, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}