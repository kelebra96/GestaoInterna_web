{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 47, "column": 0}, "map": {"version":3,"sources":["turbopack://[project]/lib/supabase-admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\n// URL e Service Key do Supabase (server-side only)\nconst supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || 'http://kong:8000';\nconst supabaseServiceKey =\n  process.env.SUPABASE_SERVICE_ROLE_KEY ||\n  process.env.SUPABASE_SECRET_KEY ||\n  process.env.SUPABASE_SERVICE_KEY ||\n  '';\n\nif (!supabaseServiceKey) {\n  console.warn('??  SUPABASE_SERVICE_ROLE_KEY or SUPABASE_SECRET_KEY not set - admin client will not work');\n}\n\n// Cliente Supabase Admin (bypassa Row Level Security)\n// APENAS para uso server-side (API routes, server components)\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n  auth: {\n    autoRefreshToken: false,\n    persistSession: false,\n  },\n});\n\n/**\n * Tipos de dados do banco\n */\n\nexport interface User {\n  id: string;\n  email: string;\n  displayName: string;\n  role: 'developer' | 'admin' | 'manager' | 'agent' | 'buyer';\n  companyId: string | null;\n  storeId: string | null;\n  storeIds: string[];\n  active: boolean;\n  createdAt: string;\n  lastSeen: string | null;\n  isOnline?: boolean;\n}\n\nexport interface Company {\n  id: string;\n  name: string;\n  tradingName?: string;\n  cnpj?: string;\n  active: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface Store {\n  id: string;\n  name: string;\n  code: string;\n  companyId: string;\n  managerId?: string | null;\n  agentId?: string | null;\n  address?: string;\n  city?: string;\n  state?: string;\n  active: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\ntype DbUser = {\n  id: string;\n  email: string;\n  display_name: string | null;\n  role: string;\n  company_id: string | null;\n  store_id: string | null;\n  store_ids: string[] | null;\n  active: boolean | null;\n  created_at: string;\n  last_seen: string | null;\n};\n\ntype DbCompany = {\n  id: string;\n  name: string;\n  cnpj: string | null;\n  trading_name: string | null;\n  active: boolean | null;\n  created_at: string;\n  updated_at: string;\n};\n\ntype DbStore = {\n  id: string;\n  name: string;\n  code: string;\n  company_id: string;\n  manager_id: string | null;\n  agent_id: string | null;\n  address: string | null;\n  city: string | null;\n  state: string | null;\n  active: boolean | null;\n  created_at: string;\n  updated_at: string;\n};\n\nfunction mapUserRow(row: DbUser): User {\n  const lastSeen = row.last_seen ?? null;\n  const isOnline = lastSeen ? (Date.now() - new Date(lastSeen).getTime() < 5 * 60 * 1000) : false;\n  return {\n    id: row.id,\n    email: row.email,\n    displayName: row.display_name || row.email || 'Sem nome',\n    role: row.role as User['role'],\n    companyId: row.company_id,\n    storeId: row.store_id,\n    storeIds: Array.isArray(row.store_ids) ? row.store_ids : (row.store_id ? [row.store_id] : []),\n    active: row.active !== false,\n    createdAt: row.created_at,\n    lastSeen,\n    isOnline,\n  };\n}\n\nfunction mapCompanyRow(row: DbCompany): Company {\n  return {\n    id: row.id,\n    name: row.name,\n    tradingName: row.trading_name ?? undefined,\n    cnpj: row.cnpj ?? undefined,\n    active: row.active !== false,\n    createdAt: row.created_at,\n    updatedAt: row.updated_at,\n  };\n}\n\nfunction mapStoreRow(row: DbStore): Store {\n  return {\n    id: row.id,\n    name: row.name,\n    code: row.code,\n    companyId: row.company_id,\n    managerId: row.manager_id ?? null,\n    agentId: row.agent_id ?? null,\n    address: row.address ?? undefined,\n    city: row.city ?? undefined,\n    state: row.state ?? undefined,\n    active: row.active !== false,\n    createdAt: row.created_at,\n    updatedAt: row.updated_at,\n  };\n}\n\n/**\n * Helper Functions para opera‡äes comuns\n */\n\n// ========================================\n// USERS\n// ========================================\n\nexport async function getAllUsers() {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .order('created_at', { ascending: false });\n\n  if (error) throw error;\n  return (data || []).map(mapUserRow);\n}\n\nexport async function getUserById(userId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .eq('id', userId)\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function getUsersByCompany(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .select('*')\n    .eq('company_id', companyId)\n    .order('created_at', { ascending: false });\n\n  if (error) throw error;\n  return (data || []).map(mapUserRow);\n}\n\nexport async function createUser(user: Partial<User>) {\n  const payload = {\n    id: user.id,\n    email: user.email,\n    display_name: user.displayName ?? null,\n    role: user.role,\n    company_id: user.companyId ?? null,\n    store_id: user.storeId ?? null,\n    store_ids: user.storeIds ?? (user.storeId ? [user.storeId] : []),\n    active: user.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function updateUser(userId: string, updates: Partial<User>) {\n  const payload: Partial<DbUser> & { updated_at?: string } = {\n    display_name: updates.displayName,\n    role: updates.role,\n    company_id: updates.companyId ?? undefined,\n    store_id: updates.storeId ?? undefined,\n    store_ids: updates.storeIds,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('users')\n    .update(payload)\n    .eq('id', userId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapUserRow(data as DbUser);\n}\n\nexport async function deleteUser(userId: string) {\n  const { error } = await supabaseAdmin\n    .from('users')\n    .delete()\n    .eq('id', userId);\n\n  if (error) throw error;\n}\n\n// ========================================\n// COMPANIES\n// ========================================\n\nexport async function getAllCompanies() {\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .select('*')\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapCompanyRow);\n}\n\nexport async function getCompanyById(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .select('*')\n    .eq('id', companyId)\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\nexport async function createCompany(company: Partial<Company>) {\n  const payload = {\n    id: company.id,\n    name: company.name,\n    trading_name: company.tradingName ?? null,\n    cnpj: company.cnpj ?? null,\n    active: company.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\nexport async function updateCompany(companyId: string, updates: Partial<Company>) {\n  const payload = {\n    name: updates.name,\n    trading_name: updates.tradingName ?? undefined,\n    cnpj: updates.cnpj ?? undefined,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('companies')\n    .update(payload)\n    .eq('id', companyId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapCompanyRow(data as DbCompany);\n}\n\n// ========================================\n// STORES\n// ========================================\n\nexport async function getAllStores() {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapStoreRow);\n}\n\nexport async function getStoresByCompany(companyId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .eq('company_id', companyId)\n    .order('name', { ascending: true });\n\n  if (error) throw error;\n  return (data || []).map(mapStoreRow);\n}\n\nexport async function getStoreById(storeId: string) {\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .select('*')\n    .eq('id', storeId)\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\nexport async function createStore(store: Partial<Store>) {\n  const payload = {\n    id: store.id,\n    name: store.name,\n    code: store.code,\n    company_id: store.companyId,\n    manager_id: store.managerId ?? null,\n    agent_id: store.agentId ?? null,\n    address: store.address ?? null,\n    city: store.city ?? null,\n    state: store.state ?? null,\n    active: store.active ?? true,\n  };\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .insert(payload)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\nexport async function updateStore(storeId: string, updates: Partial<Store>) {\n  const payload = {\n    name: updates.name,\n    code: updates.code,\n    company_id: updates.companyId,\n    manager_id: updates.managerId ?? undefined,\n    agent_id: updates.agentId ?? undefined,\n    address: updates.address ?? undefined,\n    city: updates.city ?? undefined,\n    state: updates.state ?? undefined,\n    active: typeof updates.active === 'boolean' ? updates.active : undefined,\n    updated_at: new Date().toISOString(),\n  };\n  const { data, error } = await supabaseAdmin\n    .from('stores')\n    .update(payload)\n    .eq('id', storeId)\n    .select()\n    .single();\n\n  if (error) throw error;\n  return mapStoreRow(data as DbStore);\n}\n\n/**\n * Helper para verificar JWT token do usu rio\n */\nexport async function verifyToken(token: string) {\n  const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);\n\n  if (error) throw error;\n  return user;\n}\n\nexport default supabaseAdmin;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 276, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 282, "column": 0}, "map": {"version":3,"sources":["turbopack://[project]/app/api/charts/solicitacoes-por-loja/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { supabaseAdmin } from '@/lib/supabase-admin';\nimport { NextRequest } from 'next/server';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\nexport async function GET(request: NextRequest) {\n  const { searchParams } = new URL(request.url);\n  const period = searchParams.get('period') || 'month'; // 'week', 'month', 'quarter'\n\n  const now = new Date();\n  let startDate: Date;\n\n  switch (period) {\n    case 'week':\n      startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n      break;\n    case 'quarter':\n      startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000); // Aproximadamente 3 meses\n      break;\n    case 'month':\n    default:\n      startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n      break;\n  }\n\n  try {\n    const { data, error } = await supabaseAdmin.rpc('get_solicitacoes_por_loja_por_periodo', {\n      start_date: startDate.toISOString(),\n    });\n\n    if (error) {\n      // Se a função não existir, tentamos uma abordagem de fallback\n      if (error.code === '42883') {\n        console.warn('RPC function not found, using fallback query.');\n        const fallbackData = await fallbackQuery(startDate);\n        return NextResponse.json(fallbackData);\n      }\n      throw error;\n    }\n\n    return NextResponse.json(data);\n\n  } catch (error: any) {\n    console.error('[CHARTS_API] Error fetching solicitacoes por loja:', error);\n    try {\n        console.log(\"Trying fallback query...\")\n        const fallbackData = await fallbackQuery(startDate);\n        return NextResponse.json(fallbackData);\n    } catch (fallbackError: any) {\n        console.error('[CHARTS_API] Fallback query failed:', fallbackError);\n        return NextResponse.json({\n            error: 'Failed to fetch chart data',\n            details: fallbackError?.message || 'Unknown error',\n        }, { status: 500 });\n    }\n  }\n}\n\n// Fallback em JS caso a função SQL não exista\nasync function fallbackQuery(startDate: Date) {\n    const { data: solicitacoes, error: solicitacoesError } = await supabaseAdmin\n      .from('solicitacoes')\n      .select('store_id')\n      .neq('status', 'draft')\n      .gte('created_at', startDate.toISOString());\n\n    if (solicitacoesError) throw solicitacoesError;\n\n    const counts: { [key: string]: number } = {};\n    for (const s of solicitacoes) {\n        if(s.store_id) {\n            counts[s.store_id] = (counts[s.store_id] || 0) + 1;\n        }\n    }\n\n    const storeIds = Object.keys(counts);\n    if(storeIds.length === 0) return [];\n\n    const { data: stores, error: storesError } = await supabaseAdmin\n        .from('stores')\n        .select('id, name')\n        .in('id', storeIds);\n\n    if (storesError) throw storesError;\n\n    const storeMap = new Map(stores.map(s => [s.id, s.name]));\n\n    return Object.entries(counts).map(([storeId, count]) => ({\n        storeId,\n        storeName: storeMap.get(storeId) || 'Desconhecida',\n        count,\n    })).sort((a,b) => b.count - a.count);\n}\n"],"names":[],"mappings":";;;;;AAAA;AACA;;;AAGO,MAAM,UAAU;AAChB,MAAM,aAAa;AAEnB,eAAe,IAAI,OAAoB;IAC5C,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;IAC5C,MAAM,SAAS,aAAa,GAAG,CAAC,aAAa,SAAS,6BAA6B;IAEnF,MAAM,MAAM,IAAI;IAChB,IAAI;IAEJ,OAAQ;QACN,KAAK;YACH,YAAY,IAAI,KAAK,IAAI,OAAO,KAAK,IAAI,KAAK,KAAK,KAAK;YACxD;QACF,KAAK;YACH,YAAY,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,KAAK,KAAK,KAAK,OAAO,0BAA0B;YAC1F;QACF,KAAK;QACL;YACE,YAAY,IAAI,KAAK,IAAI,OAAO,KAAK,KAAK,KAAK,KAAK,KAAK;YACzD;IACJ;IAEA,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,0HAAA,CAAA,gBAAa,CAAC,GAAG,CAAC,yCAAyC;YACvF,YAAY,UAAU,WAAW;QACnC;QAEA,IAAI,OAAO;YACT,8DAA8D;YAC9D,IAAI,MAAM,IAAI,KAAK,SAAS;gBAC1B,QAAQ,IAAI,CAAC;gBACb,MAAM,eAAe,MAAM,cAAc;gBACzC,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YAC3B;YACA,MAAM;QACR;QAEA,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;IAE3B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,sDAAsD;QACpE,IAAI;YACA,QAAQ,GAAG,CAAC;YACZ,MAAM,eAAe,MAAM,cAAc;YACzC,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;QAC7B,EAAE,OAAO,eAAoB;YACzB,QAAQ,KAAK,CAAC,uCAAuC;YACrD,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBACrB,OAAO;gBACP,SAAS,eAAe,WAAW;YACvC,GAAG;gBAAE,QAAQ;YAAI;QACrB;IACF;AACF;AAEA,8CAA8C;AAC9C,eAAe,cAAc,SAAe;IACxC,MAAM,EAAE,MAAM,YAAY,EAAE,OAAO,iBAAiB,EAAE,GAAG,MAAM,0HAAA,CAAA,gBAAa,CACzE,IAAI,CAAC,gBACL,MAAM,CAAC,YACP,GAAG,CAAC,UAAU,SACd,GAAG,CAAC,cAAc,UAAU,WAAW;IAE1C,IAAI,mBAAmB,MAAM;IAE7B,MAAM,SAAoC,CAAC;IAC3C,KAAK,MAAM,KAAK,aAAc;QAC1B,IAAG,EAAE,QAAQ,EAAE;YACX,MAAM,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,MAAM,CAAC,EAAE,QAAQ,CAAC,IAAI,CAAC,IAAI;QACrD;IACJ;IAEA,MAAM,WAAW,OAAO,IAAI,CAAC;IAC7B,IAAG,SAAS,MAAM,KAAK,GAAG,OAAO,EAAE;IAEnC,MAAM,EAAE,MAAM,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,0HAAA,CAAA,gBAAa,CAC3D,IAAI,CAAC,UACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM;IAEd,IAAI,aAAa,MAAM;IAEvB,MAAM,WAAW,IAAI,IAAI,OAAO,GAAG,CAAC,CAAA,IAAK;YAAC,EAAE,EAAE;YAAE,EAAE,IAAI;SAAC;IAEvD,OAAO,OAAO,OAAO,CAAC,QAAQ,GAAG,CAAC,CAAC,CAAC,SAAS,MAAM,GAAK,CAAC;YACrD;YACA,WAAW,SAAS,GAAG,CAAC,YAAY;YACpC;QACJ,CAAC,GAAG,IAAI,CAAC,CAAC,GAAE,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK;AACvC"}},
    {"offset": {"line": 365, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}